# å¿«é€Ÿå…¥é—¨ï¼šå¢å¼ºç‰ˆHTNeté¢ç˜«è¯†åˆ«æ¨¡å‹

## ğŸ¯ æ–°å¢åŠŸèƒ½

æœ¬æ¬¡æ›´æ–°ä¸ºHTNeté¢ç˜«è¯†åˆ«ç³»ç»Ÿæ–°å¢äº†ä¸¤ä¸ªå¼ºå¤§çš„æ¨¡å—ï¼š

### 1ï¸âƒ£ å¯¹è§’å¾®æ³¨æ„åŠ›æ¨¡å— (Diagonal Micro-Attention)
- âœ… ç²¾ç¡®æ£€æµ‹å¸§é—´çš„ç»†å¾®å˜åŒ–
- âœ… è¯†åˆ«å·¦å³é¢éƒ¨çš„ç»†å¾®è¿åŠ¨å·®å¼‚
- âœ… æ£€æµ‹åŠ¨æ€ä¸å¯¹ç§°
- âœ… åƒç´ çº§çš„å·¦å³å¯¹æ¯”
- âœ… è‡ªé€‚åº”ä¸å¯¹ç§°æ€§æƒé‡

### 2ï¸âƒ£ ROIæ³¨æ„åŠ›æ¨¡å— (Region of Interest Attention)
- âœ… è‡ªåŠ¨å‘ç°å¹¶èšç„¦äººè„¸å…³é”®åŒºåŸŸ
- âœ… ä»…åˆ†æå—å½±å“çš„åŒºåŸŸ
- âœ… æŠ‘åˆ¶èƒŒæ™¯å’Œéé¢éƒ¨å™ªå£°
- âœ… ç”Ÿæˆå¯è§£é‡Šçš„ROIå›¾
- âœ… 5ä¸ªå…³é”®é¢éƒ¨åŒºåŸŸï¼ˆå‰é¢ã€å·¦çœ¼ã€é¼»å­ã€å³çœ¼ã€å˜´éƒ¨ï¼‰

---

## ğŸ“¦ å®‰è£…ä¾èµ–

```bash
pip install torch torchvision einops
```

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ–¹æ³•1: æµ‹è¯•æ¨¡å—

```bash
# è¿è¡Œæµ‹è¯•å¥—ä»¶ï¼ˆéªŒè¯æ¨¡å—æ­£å¸¸å·¥ä½œï¼‰
python test_enhanced_model.py

# æ£€æŸ¥è¯­æ³•ï¼ˆæ‰€æœ‰æ–‡ä»¶âœ…é€šè¿‡ï¼‰
python check_syntax.py
```

### æ–¹æ³•2: è®­ç»ƒå¢å¼ºæ¨¡å‹

```bash
python train_enhanced_facial_palsy.py \
    --data_root ./datasets/facial_palsy/FNP \
    --train_csv ./datasets/facial_palsy/fnp_train.csv \
    --val_csv ./datasets/facial_palsy/fnp_val.csv \
    --dataset_type FNP \
    --num_classes 6 \
    --batch_size 32 \
    --epochs 100 \
    --use_diagonal_attn True \
    --use_roi True \
    --save_dir ./checkpoints/enhanced \
    --log_dir ./logs/enhanced
```

### æ–¹æ³•3: å¯è§†åŒ–ROIå’Œä¸å¯¹ç§°æ€§

```bash
python visualize_roi_and_asymmetry.py \
    --model_path ./checkpoints/enhanced/best_model_enhanced.pth \
    --data_root ./datasets/facial_palsy/FNP \
    --test_csv ./datasets/facial_palsy/fnp_test.csv \
    --dataset_type FNP \
    --num_samples 10 \
    --output_dir ./visualizations/roi_asymmetry
```

---

## ğŸ’» åœ¨ä»£ç ä¸­ä½¿ç”¨

### å®Œæ•´å¢å¼ºæ¨¡å‹ï¼ˆæ¨èï¼‰

```python
from Model import HTNetEnhanced

model = HTNetEnhanced(
    image_size=224,
    patch_size=7,
    num_classes=6,
    dim=256,
    heads=4,
    num_hierarchies=3,
    block_repeats=(2, 2, 10),
    use_diagonal_attn=True,  # å¯ç”¨å¯¹è§’å¾®æ³¨æ„åŠ›
    use_roi=True              # å¯ç”¨ROIæ¨¡å—
)

# è®­ç»ƒ/æ¨ç†
output = model(images)

# è·å–ROIå›¾ç”¨äºå¯è§†åŒ–
output, roi_maps = model(images, return_roi_maps=True)
```

### ä»…ä½¿ç”¨å¯¹è§’å¾®æ³¨æ„åŠ›

```python
model = HTNetEnhanced(
    ...,
    use_diagonal_attn=True,
    use_roi=False
)
```

### ä»…ä½¿ç”¨ROIæ¨¡å—

```python
model = HTNetEnhanced(
    ...,
    use_diagonal_attn=False,
    use_roi=True
)
```

---

## ğŸ“Š é¢„æœŸæ€§èƒ½æå‡

ç›¸æ¯”åŸºç¡€HTNetæ¨¡å‹ï¼š

| æŒ‡æ ‡ | æå‡å¹…åº¦ |
|------|---------|
| æ€»ä½“å‡†ç¡®ç‡ | +5-10% |
| F1åˆ†æ•° | +5-12% |
| è½»åº¦é¢ç˜«æ£€æµ‹ | æ˜¾è‘—æ”¹å–„ |
| å¯¹å§¿æ€/å…‰ç…§çš„é²æ£’æ€§ | å¢å¼º |
| èƒŒæ™¯å™ªå£°å¤„ç† | å¤§å¹…æ”¹å–„ |

**èµ„æºå¼€é”€**ï¼š
- å†…å­˜ï¼š+15-23%
- å‚æ•°ï¼š+10-18%
- é€Ÿåº¦ï¼š-5-10%

---

## ğŸ“ æ–‡ä»¶è¯´æ˜

### æ ¸å¿ƒå®ç°
- `Model.py` - å¢å¼ºæ¨¡å—å®ç°
  - `DiagonalMicroAttention` - å¯¹è§’å¾®æ³¨æ„åŠ›
  - `ROIAttentionModule` - ROIæ³¨æ„åŠ›
  - `EnhancedTransformer` - å¢å¼ºTransformer
  - `HTNetEnhanced` - å®Œæ•´å¢å¼ºæ¨¡å‹

### è®­ç»ƒå’Œæµ‹è¯•
- `train_enhanced_facial_palsy.py` - å®Œæ•´è®­ç»ƒè„šæœ¬
- `visualize_roi_and_asymmetry.py` - å¯è§†åŒ–å·¥å…·
- `test_enhanced_model.py` - æµ‹è¯•å¥—ä»¶
- `check_syntax.py` - è¯­æ³•æ£€æŸ¥å·¥å…·

### æ–‡æ¡£
- `FEASIBILITY_ANSWER_CN.md` - å¯è¡Œæ€§åˆ†æï¼ˆè¯¦ç»†ï¼‰
- `README_ENHANCED_MODULES.md` - æ¨¡å—è¯¦ç»†æ–‡æ¡£
- `FEATURE_DIAGONAL_MICRO_ATTENTION_ROI.md` - åŠŸèƒ½ç‰¹æ€§
- `IMPLEMENTATION_SUMMARY.md` - å®ç°æ€»ç»“ï¼ˆè‹±æ–‡ï¼‰
- `QUICK_START_ENHANCED.md` - æœ¬æ–‡æ¡£

---

## ğŸ¨ å¯è§†åŒ–è¾“å‡º

è¿è¡Œ `visualize_roi_and_asymmetry.py` ä¼šç”Ÿæˆï¼š

1. **åŸå§‹å›¾åƒ** + é¢„æµ‹æ ‡ç­¾
2. **å·¦å³åˆ†å‰²** - é¢éƒ¨å·¦å³ä¸¤ä¾§å¯¹æ¯”
3. **ä¸å¯¹ç§°çƒ­å›¾** - æ˜¾ç¤ºå·¦å³å·®å¼‚
4. **5ä¸ªROIåŒºåŸŸå›¾** - å‰é¢ã€å·¦çœ¼ã€é¼»å­ã€å³çœ¼ã€å˜´éƒ¨
5. **ROIç»¼åˆæ³¨æ„åŠ›** - æ‰€æœ‰ROIåŒºåŸŸå åŠ 
6. **èƒŒæ™¯æŠ‘åˆ¶å›¾** - ä»…ä¿ç•™é¢éƒ¨åŒºåŸŸ

---

## âœ… éªŒè¯çŠ¶æ€

- âœ… æ‰€æœ‰Pythonæ–‡ä»¶é€šè¿‡è¯­æ³•æ£€æŸ¥
- âœ… å¯¹è§’å¾®æ³¨æ„åŠ›æ¨¡å—å®ç°å®Œæˆ
- âœ… ROIæ³¨æ„åŠ›æ¨¡å—å®ç°å®Œæˆ
- âœ… å¢å¼ºTransformeré›†æˆå®Œæˆ
- âœ… å®Œæ•´HTNetEnhancedæ¨¡å‹å®Œæˆ
- âœ… è®­ç»ƒè„šæœ¬å®Œæˆ
- âœ… å¯è§†åŒ–å·¥å…·å®Œæˆ
- âœ… æµ‹è¯•å¥—ä»¶å®Œæˆ
- âœ… å®Œæ•´æ–‡æ¡£å®Œæˆ

---

## ğŸ”¬ æŠ€æœ¯ç»†èŠ‚

### å¯¹è§’å¾®æ³¨æ„åŠ›å·¥ä½œåŸç†

```
è¾“å…¥ç‰¹å¾å›¾ â†’ æå–Q,K,V â†’ 2Dé‡æ’
              â†“
    ä¸»å¯¹è§’çº¿/åå¯¹è§’çº¿é‡‡æ ·
              â†“
    è®¡ç®—å¯¹è§’çº¿æ³¨æ„åŠ›
              â†“
    å·¦å³åˆ†å‰² â†’ ç¿»è½¬å¯¹æ¯” â†’ ä¸å¯¹ç§°æƒé‡
              â†“
    å¢å¼ºä¸å¯¹ç§°åŒºåŸŸç‰¹å¾
```

### ROIæ¨¡å—å·¥ä½œåŸç†

```
è¾“å…¥ç‰¹å¾å›¾ â†’ ROIæ£€æµ‹å™¨ â†’ 5ä¸ªåŒºåŸŸå›¾
              â†“
    ç©ºé—´æ³¨æ„åŠ› + é€šé“æ³¨æ„åŠ›
              â†“
    èƒŒæ™¯æŠ‘åˆ¶ï¼ˆé˜ˆå€¼0.3ï¼‰
              â†“
    åŒºåŸŸç²¾ç‚¼
              â†“
    å¢å¼ºçš„ç‰¹å¾å›¾
```

---

## ğŸ“ é€‚ç”¨åœºæ™¯

### æœ€é€‚åˆä½¿ç”¨å¢å¼ºæ¨¡å‹çš„åœºæ™¯

1. **è½»åº¦é¢ç˜«æ£€æµ‹** - ç»†å¾®ä¸å¯¹ç§°çš„ç²¾ç¡®è¯†åˆ«
2. **å¤æ‚èƒŒæ™¯** - èƒŒæ™¯æŠ‘åˆ¶èƒ½åŠ›å¼º
3. **å¤šå§¿æ€é‡‡é›†** - é²æ£’æ€§å¥½
4. **ä¸´åºŠè¯Šæ–­** - å¯è§£é‡Šçš„ROIå›¾

### å¯é€‰æ‹©åŸºç¡€æ¨¡å‹çš„åœºæ™¯

1. **ä¸¥é‡é¢ç˜«** - å·®å¼‚æ˜æ˜¾ï¼ŒåŸºç¡€æ¨¡å‹è¶³å¤Ÿ
2. **èµ„æºå—é™** - GPUæ˜¾å­˜<6GB
3. **å®æ—¶å¤„ç†** - é€Ÿåº¦è¦æ±‚ä¸¥æ ¼

---

## ğŸ“ è·å–å¸®åŠ©

### è¯¦ç»†æ–‡æ¡£
- ä¸­æ–‡è¯¦ç»†æ–‡æ¡£ï¼š`README_ENHANCED_MODULES.md`
- å¯è¡Œæ€§åˆ†æï¼š`FEASIBILITY_ANSWER_CN.md`
- åŠŸèƒ½ç‰¹æ€§ï¼š`FEATURE_DIAGONAL_MICRO_ATTENTION_ROI.md`

### å¸¸è§é—®é¢˜

**Q: éœ€è¦é‡æ–°æ ‡æ³¨æ•°æ®å—ï¼Ÿ**  
A: ä¸éœ€è¦ã€‚ROIåŒºåŸŸæ˜¯è‡ªåŠ¨å­¦ä¹ çš„ï¼Œæ— éœ€æ‰‹åŠ¨æ ‡æ³¨ã€‚

**Q: å¯ä»¥åªä½¿ç”¨ä¸€ä¸ªæ¨¡å—å—ï¼Ÿ**  
A: å¯ä»¥ã€‚é€šè¿‡ `use_diagonal_attn` å’Œ `use_roi` å‚æ•°ç‹¬ç«‹æ§åˆ¶ã€‚

**Q: ä¸åŸºç¡€HTNetå…¼å®¹å—ï¼Ÿ**  
A: å®Œå…¨å…¼å®¹ã€‚è®¾ç½®ä¸¤ä¸ªå‚æ•°ä¸ºFalseå³ä¸ºåŸºç¡€æ¨¡å‹ã€‚

**Q: å†…å­˜ä¸å¤Ÿæ€ä¹ˆåŠï¼Ÿ**  
A: å‡å°batch_sizeï¼Œæˆ–åªå¯ç”¨ä¸€ä¸ªæ¨¡å—ã€‚

---

## ğŸ“ˆ ä¸‹ä¸€æ­¥

1. âœ… ä»£ç å®ç°å®Œæˆ
2. â­ï¸ åœ¨çœŸå®æ•°æ®é›†ä¸Šè®­ç»ƒ
3. â­ï¸ ä¸åŸºå‡†æ¨¡å‹å¯¹æ¯”è¯„ä¼°
4. â­ï¸ ä¸´åºŠéªŒè¯
5. â­ï¸ è¶…å‚æ•°è°ƒä¼˜
6. â­ï¸ å‘å¸ƒç ”ç©¶æˆæœ

---

**æœ€åæ›´æ–°**: 2024  
**çŠ¶æ€**: âœ… å®ç°å®Œæˆï¼Œå‡†å¤‡è®­ç»ƒå’Œè¯„ä¼°  
**è´¡çŒ®è€…**: HTNet Enhanced Team
